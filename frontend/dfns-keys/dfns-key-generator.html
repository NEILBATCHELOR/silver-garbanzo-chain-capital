<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFNS Key Pair Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .key-display {
            background: #e9ecef;
            border: 2px dashed #6c757d;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .public-key {
            border-color: #28a745;
            background: #d4edda;
        }
        .private-key {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            color: #155724;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë DFNS Key Pair Generator</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> This tool generates cryptographic keys for DFNS API authentication. Keep your private keys secure and never share them!
        </div>

        <div>
            <button id="checkSupport" class="button">Check Crypto Support</button>
            <button id="generateEDDSA" class="button">Generate EDDSA (Recommended)</button>
            <button id="generateECDSA" class="button">Generate ECDSA</button>
            <button id="generateRSA" class="button">Generate RSA</button>
            <button id="clearOutput" class="button">Clear Output</button>
        </div>

        <div id="output" class="output" style="display: none;"></div>
        
        <div id="keyDisplay" style="display: none;">
            <h3>Generated Keys:</h3>
            <div>
                <strong>üîë Public Key (copy to DFNS):</strong>
                <div id="publicKey" class="key-display public-key"></div>
                <button id="copyPublic" class="button">Copy Public Key</button>
            </div>
            <div>
                <strong>üîí Private Key (save securely):</strong>
                <div id="privateKey" class="key-display private-key"></div>
                <button id="copyPrivate" class="button">Copy Private Key</button>
            </div>
        </div>

        <div class="success" id="instructions" style="display: none;">
            <h3>üìã Next Steps:</h3>
            <ol>
                <li>Copy the <strong>Public Key</strong> above</li>
                <li>Go to <a href="https://dashboard.dfns.co" target="_blank">DFNS Dashboard</a> ‚Üí Credentials</li>
                <li>Create a new credential using the public key</li>
                <li>Generate a new Personal Access Token (PAT)</li>
                <li>Update your environment variables with the new credentials</li>
                <li>Save the <strong>Private Key</strong> securely for future signing operations</li>
            </ol>
        </div>
    </div>

    <script type="module">
        // Inline the key generation code since we can't import modules in this context
        
        class DfnsKeyPairGenerator {
            static async generateEDDSAKeyPair() {
                const keyPair = await window.crypto.subtle.generateKey(
                    { name: 'Ed25519' },
                    true,
                    ['sign', 'verify']
                );

                const publicKeyPem = await this.exportPublicKeyToPEM(keyPair.publicKey);
                const privateKeyPem = await this.exportPrivateKeyToPEM(keyPair.privateKey);

                return {
                    publicKey: publicKeyPem,
                    privateKey: privateKeyPem,
                    algorithm: 'EDDSA',
                    curve: 'Ed25519'
                };
            }

            static async generateECDSAKeyPair() {
                const keyPair = await window.crypto.subtle.generateKey(
                    { name: 'ECDSA', namedCurve: 'P-256' },
                    true,
                    ['sign', 'verify']
                );

                const publicKeyPem = await this.exportPublicKeyToPEM(keyPair.publicKey);
                const privateKeyPem = await this.exportPrivateKeyToPEM(keyPair.privateKey);

                return {
                    publicKey: publicKeyPem,
                    privateKey: privateKeyPem,
                    algorithm: 'ECDSA',
                    curve: 'secp256r1'
                };
            }

            static async generateRSAKeyPair() {
                const keyPair = await window.crypto.subtle.generateKey(
                    {
                        name: 'RSA-PSS',
                        modulusLength: 3072,
                        publicExponent: new Uint8Array([1, 0, 1]),
                        hash: 'SHA-256',
                    },
                    true,
                    ['sign', 'verify']
                );

                const publicKeyPem = await this.exportPublicKeyToPEM(keyPair.publicKey);
                const privateKeyPem = await this.exportPrivateKeyToPEM(keyPair.privateKey);

                return {
                    publicKey: publicKeyPem,
                    privateKey: privateKeyPem,
                    algorithm: 'RSA'
                };
            }

            static async exportPublicKeyToPEM(key) {
                const exported = await window.crypto.subtle.exportKey('spki', key);
                const exportedAsBase64 = btoa(String.fromCharCode(...new Uint8Array(exported)));
                const pemExported = `-----BEGIN PUBLIC KEY-----\n${exportedAsBase64.match(/.{1,64}/g)?.join('\n')}\n-----END PUBLIC KEY-----`;
                return pemExported;
            }

            static async exportPrivateKeyToPEM(key) {
                const exported = await window.crypto.subtle.exportKey('pkcs8', key);
                const exportedAsBase64 = btoa(String.fromCharCode(...new Uint8Array(exported)));
                const pemExported = `-----BEGIN PRIVATE KEY-----\n${exportedAsBase64.match(/.{1,64}/g)?.join('\n')}\n-----END PRIVATE KEY-----`;
                return pemExported;
            }

            static checkCryptoSupport() {
                const issues = [];
                const algorithms = { ECDSA: false, EDDSA: false, RSA: false };

                if (!window.crypto || !window.crypto.subtle) {
                    issues.push('Web Crypto API not available');
                    return { supported: false, algorithms, issues };
                }

                // Assume modern browsers support these
                algorithms.ECDSA = true;
                algorithms.EDDSA = true;
                algorithms.RSA = true;

                return { supported: issues.length === 0, algorithms, issues };
            }
        }

        // UI handlers
        const output = document.getElementById('output');
        const keyDisplay = document.getElementById('keyDisplay');
        const publicKeyEl = document.getElementById('publicKey');
        const privateKeyEl = document.getElementById('privateKey');
        const instructions = document.getElementById('instructions');

        function log(message) {
            output.style.display = 'block';
            output.textContent += message + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function showKeys(keys) {
            publicKeyEl.textContent = keys.publicKey;
            privateKeyEl.textContent = keys.privateKey;
            keyDisplay.style.display = 'block';
            instructions.style.display = 'block';
        }

        function setLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Generating...';
            } else {
                button.disabled = false;
                button.innerHTML = button.originalText;
            }
        }

        // Store original button text
        document.querySelectorAll('button').forEach(btn => {
            btn.originalText = btn.textContent;
        });

        document.getElementById('checkSupport').addEventListener('click', () => {
            log('üîç Checking Web Crypto API support...');
            const support = DfnsKeyPairGenerator.checkCryptoSupport();
            
            if (support.supported) {
                log('‚úÖ Web Crypto API is supported!');
                log('   - ECDSA: ' + (support.algorithms.ECDSA ? '‚úÖ' : '‚ùå'));
                log('   - EDDSA: ' + (support.algorithms.EDDSA ? '‚úÖ' : '‚ùå'));
                log('   - RSA: ' + (support.algorithms.RSA ? '‚úÖ' : '‚ùå'));
            } else {
                log('‚ùå Web Crypto API issues: ' + support.issues.join(', '));
            }
        });

        document.getElementById('generateEDDSA').addEventListener('click', async () => {
            setLoading('generateEDDSA', true);
            log('üîê Generating EDDSA (Ed25519) key pair...');
            
            try {
                const keys = await DfnsKeyPairGenerator.generateEDDSAKeyPair();
                log('‚úÖ EDDSA key pair generated successfully!');
                log('   Algorithm: ' + keys.algorithm);
                log('   Curve: ' + keys.curve);
                showKeys(keys);
            } catch (error) {
                log('‚ùå Failed to generate EDDSA keys: ' + error.message);
            } finally {
                setLoading('generateEDDSA', false);
            }
        });

        document.getElementById('generateECDSA').addEventListener('click', async () => {
            setLoading('generateECDSA', true);
            log('üîê Generating ECDSA (secp256r1) key pair...');
            
            try {
                const keys = await DfnsKeyPairGenerator.generateECDSAKeyPair();
                log('‚úÖ ECDSA key pair generated successfully!');
                log('   Algorithm: ' + keys.algorithm);
                log('   Curve: ' + keys.curve);
                showKeys(keys);
            } catch (error) {
                log('‚ùå Failed to generate ECDSA keys: ' + error.message);
            } finally {
                setLoading('generateECDSA', false);
            }
        });

        document.getElementById('generateRSA').addEventListener('click', async () => {
            setLoading('generateRSA', true);
            log('üîê Generating RSA (3072 bits) key pair...');
            
            try {
                const keys = await DfnsKeyPairGenerator.generateRSAKeyPair();
                log('‚úÖ RSA key pair generated successfully!');
                log('   Algorithm: ' + keys.algorithm);
                showKeys(keys);
            } catch (error) {
                log('‚ùå Failed to generate RSA keys: ' + error.message);
            } finally {
                setLoading('generateRSA', false);
            }
        });

        document.getElementById('copyPublic').addEventListener('click', () => {
            navigator.clipboard.writeText(publicKeyEl.textContent).then(() => {
                log('‚úÖ Public key copied to clipboard!');
            }).catch(err => {
                log('‚ùå Failed to copy: ' + err.message);
            });
        });

        document.getElementById('copyPrivate').addEventListener('click', () => {
            navigator.clipboard.writeText(privateKeyEl.textContent).then(() => {
                log('‚úÖ Private key copied to clipboard!');
            }).catch(err => {
                log('‚ùå Failed to copy: ' + err.message);
            });
        });

        document.getElementById('clearOutput').addEventListener('click', () => {
            output.textContent = '';
            output.style.display = 'none';
            keyDisplay.style.display = 'none';
            instructions.style.display = 'none';
        });

        // Initial check
        log('üöÄ DFNS Key Pair Generator loaded!');
        log('Click "Check Crypto Support" to verify browser compatibility.');
    </script>
</body>
</html>
